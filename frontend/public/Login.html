<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login</title>
  <link rel="stylesheet" href="/frontend/public/styles/login.css">
</head>

<body>
  <!-- Navbar -->
  <header>
    <div class="logo">
      <span>ðŸŒ¿</span> Mental Health
    </div>
    <button class="signup-btn" onclick="handleSignupRedirect()">Sign Up</button>
  </header>

  <!-- Login Card -->
  <div class="container">
    <div class="card">
      <h1>Welcome Back</h1>
      
      <!-- Message containers -->
      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>
      
      <form id="loginForm">
        <input type="email" id="email" name="email" placeholder="Email" required />
        <input type="password" id="password" name="password" placeholder="Password" required />

        <div class="options">
          <label><input type="checkbox" id="rememberMe" name="rememberMe" /> Remember me</label>
          <a href="#">Forgot Password?</a>
        </div>

        <button type="submit" id="loginBtn" class="login-btn">Log In</button>
      </form>

      <p class="signup-text">Don't have an account? <a href="/frontend/public/signup.html">Sign Up</a></p>
    </div>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    // Utility functions
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    function hideMessages() {
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function validateForm(email, password) {
      if (!email || !validateEmail(email)) {
        return { isValid: false, message: 'Please enter a valid email address' };
      }
      if (!password || password.length < 1) {
        return { isValid: false, message: 'Please enter your password' };
      }
      return { isValid: true };
    }

    // Form submission handler
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      hideMessages();

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      const validation = validateForm(email, password);
      if (!validation.isValid) {
        showError(validation.message);
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging In...';

      try {
        const result = await loginUser({ email, password, rememberMe });
        showSuccess(result.message || 'Login successful! Redirecting...');

        // Store token and user data
        if (result.token || result.data?.token) {
          const token = result.token || result.data?.token;
          const storage = rememberMe ? localStorage : sessionStorage;
          storage.setItem('authToken', token);

          const userData = result.user || result.data?.user;
          if (userData) {
            storage.setItem('user', JSON.stringify(userData));
          }
        }

        // Redirect to home page
        setTimeout(() => {
          window.location.href = '/frontend/public/home.html';
        }, 1500);

      } catch (error) {
        showError(error.message || 'Login failed. Please try again.');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log In';
      }
    });

    // API call for user login
    async function loginUser(userData) {
      const isLiveServer = window.location.hostname === '127.0.0.1' && window.location.port === '5500';
      const API_BASE_URL = isLiveServer ? 'http://localhost:5000' : '';

      const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userData.email, password: userData.password })
      });

      if (!response.ok) {
        let errorMessage = `Server error: ${response.status} ${response.statusText}`;
        try {
          const errorData = await response.json();
          if (errorData.message) errorMessage = errorData.message;
          else if (errorData.error) errorMessage = errorData.error;
        } catch {}
        throw new Error(errorMessage);
      }

      return response.json();
    }

    // Signup redirect
    function handleSignupRedirect() {
      window.location.href = '/frontend/public/signup.html';
    }

    // Check if already logged in
    document.addEventListener('DOMContentLoaded', function() {
      const userToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
      if (userToken) {
        setTimeout(() => {
          window.location.href = '/frontend/public/home.html';
        }, 1000);
      }
    });

    // Handle enter key
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loginForm.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>

</html>
